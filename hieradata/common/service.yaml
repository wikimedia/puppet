# Service catalog.
# This entry includes all the information about the WMF internal and external load-balanced services.
# Every entry in the hash must have a label (the service name) and its body must adhere to the
# Wmflib::Service type. Refer to the documentation of that type, and all the sub-types, for details.
service::catalog:
  apaches: # TODO: rename to "appservers"
    description: Main MediaWiki application server cluster, appservers.svc.%{::site}.wmnet
    encryption: false
    ip: &appservers_ips
      codfw:
        default: 10.2.1.1
      eqiad:
        default: 10.2.2.1
    lvs:
      class: low-traffic
      conftool:
        cluster: appserver
        service: apache2
      depool_threshold: ".7"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://www.wikidata.org/wiki/Special:BlankPage
          http_status: 302
      scheduler: wrr
    monitoring:
      check_command: check_http_lvs!en.wikipedia.org!/wiki/Special:BlankPage
      critical: true
      sites:
        codfw:
          hostname: appservers.svc.codfw.wmnet
        eqiad:
          hostname: appservers.svc.eqiad.wmnet
    port: 80
    sites:
      - eqiad
      - codfw
    state: production
  apertium:
    description: Machine Translation service. apertium.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.11
      eqiad:
        default: 10.2.2.11
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/listPairs
      scheduler: wrr
    monitoring:
      check_command: check_https_lvs_on_port!apertium.discovery.wmnet!4737!/listPairs
      critical: false
      sites:
        codfw:
          hostname: apertium.svc.codfw.wmnet
        eqiad:
          hostname: apertium.svc.eqiad.wmnet
    port: 4737
    sites:
      - codfw
      - eqiad
    state: production
    discovery:
      - dnsdisc: apertium
        active_active: true
  api:
    description: MediaWiki API cluster, api.svc.%{::site}.wmnet
    encryption: false
    ip: &api_ips
      codfw:
        default: 10.2.1.22
      eqiad:
        default: 10.2.2.22
    lvs:
      class: low-traffic
      conftool:
        cluster: api_appserver
        service: apache2
      depool_threshold: ".7"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://en.wikipedia.org/w/api.php
      scheduler: wrr
    monitoring:
      check_command: check_http_lvs!en.wikipedia.org!/w/api.php?action=query&meta=siteinfo
      critical: true
      sites:
        codfw:
          hostname: api.svc.codfw.wmnet
        eqiad:
          hostname: api.svc.eqiad.wmnet
    port: 80
    sites:
      - eqiad
      - codfw
    state: production
  api-https:
    description: MediaWiki API cluster, api.svc.%{::site}.wmnet
    encryption: true
    ip: *api_ips
    lvs:
      class: low-traffic
      conftool:
        cluster: api_appserver
        service: nginx
      depool_threshold: ".7"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://en.wikipedia.org/w/api.php
      scheduler: wrr
    monitoring:
      check_command: check_https_url!en.wikipedia.org!/w/api.php?action=query&meta=siteinfo
      critical: true
      sites:
        codfw:
          hostname: api.svc.codfw.wmnet
        eqiad:
          hostname: api.svc.eqiad.wmnet
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery: &api_discovery
      - dnsdisc: api-rw
        active_active: false
      - dnsdisc: api-ro
        active_active: true
  appservers-https:
    description:
      Main MediaWiki application server cluster, appservers.svc.%{::site}.wmnet
      (https)
    encryption: true
    ip: *appservers_ips
    lvs:
      class: low-traffic
      conftool:
        cluster: appserver
        service: nginx
      depool_threshold: ".7"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://en.wikipedia.org/wiki/Special:BlankPage
      scheduler: wrr
    monitoring:
      check_command: check_https_url!en.wikipedia.org!/wiki/Special:BlankPage
      critical: true
      sites:
        codfw:
          hostname: appservers.svc.codfw.wmnet
        eqiad:
          hostname: appservers.svc.eqiad.wmnet
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery: &appservers-disc
      - dnsdisc: appservers-ro
        active_active: true
      - dnsdisc: appservers-rw
        active_active: false
  aqs:
    description: Analytics Query Service, aqs.svc.%{::site}.wmnet
    encryption: false
    ip:
      eqiad:
        default: 10.2.2.12
    lvs:
      class: low-traffic
      conftool:
        cluster: aqs
        service: aqs
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/
      scheduler: wrr
    monitoring:
      check_command: check_http_lvs_on_port!aqs.svc.eqiad.wmnet!7232!/
      critical: true
      sites:
        eqiad:
          hostname: aqs.svc.eqiad.wmnet
    port: 7232
    sites:
      - eqiad
    state: production
  blubberoid:
    description: Blubberoid, blubberoid.svc.%{::site}.wmnet (https)
    encryption: true
    ip:
      codfw:
        default: 10.2.1.31
      eqiad:
        default: 10.2.2.31
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    monitoring:
      check_command: check_https_port_status!4666!200!/?spec
      critical: false
      sites:
        codfw:
          hostname: blubberoid.svc.codfw.wmnet
        eqiad:
          hostname: blubberoid.svc.eqiad.wmnet
    port: 4666
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: blubberoid
        active_active: true
  citoid:
    description: Citation lookup service, citoid.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.19
      eqiad:
        default: 10.2.2.19
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/_info
      scheduler: wrr
    monitoring:
      check_command: check_https_lvs_on_port!citoid.discovery.wmnet!4003!/_info
      contact_group: admins,parsoid
      critical: true
      sites:
        codfw:
          hostname: citoid.svc.codfw.wmnet
        eqiad:
          hostname: citoid.svc.eqiad.wmnet
    port: 4003
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: citoid
        active_active: true
  cloudelastic-chi-https:
    description:
      Elasticsearch prod replica for WMF Cloud (Chi Cluster) - Prod MW
      AppServer Port - HTTPS
    encryption: true
    ip:
      eqiad: &id004
        cloudelasticlb: 208.80.154.241
        cloudelasticlb6: 2620:0:861:ed1a::3:241
    lvs:
      class: high-traffic2
      conftool:
        cluster: cloudelastic
        service: cloudelastic-chi-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    port: 9243
    sites:
      - eqiad
    state: production
  cloudelastic-chi-https-public:
    description:
      Elasticsearch prod replica for WMF Cloud (Chi Cluster) - Public Internet
      Port - HTTPS
    encryption: true
    ip:
      eqiad: *id004
    lvs:
      class: high-traffic2
      conftool:
        cluster: cloudelastic
        service: cloudelastic-chi-ssl-public
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    port: 8243
    sites:
      - eqiad
    state: production
  cloudelastic-omega-https:
    description:
      Elasticsearch prod replica for WMF Cloud (Omega Cluster) - Prod MW
      AppServer Port - HTTPS
    encryption: true
    ip:
      eqiad: *id004
    lvs:
      class: high-traffic2
      conftool:
        cluster: cloudelastic
        service: cloudelastic-omega-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    port: 9443
    sites:
      - eqiad
    state: production
  cloudelastic-omega-https-public:
    description:
      Elasticsearch prod replica for WMF Cloud (Omega Cluster) - Public
      Internet Port - HTTPS
    encryption: true
    ip:
      eqiad: *id004
    lvs:
      class: high-traffic2
      conftool:
        cluster: cloudelastic
        service: cloudelastic-omega-ssl-public
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    port: 8443
    sites:
      - eqiad
    state: production
  cloudelastic-psi-https:
    description:
      Elasticsearch prod replica for WMF Cloud (Psi Cluster) - Prod MW
      AppServer Port - HTTPS
    encryption: true
    ip:
      eqiad: *id004
    lvs:
      class: high-traffic2
      conftool:
        cluster: cloudelastic
        service: cloudelastic-psi-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    port: 9643
    sites:
      - eqiad
    state: production
  cloudelastic-psi-https-public:
    description:
      Elasticsearch prod replica for WMF Cloud (Psi Cluster) - Public Internet
      Port - HTTPS
    encryption: true
    ip:
      eqiad: *id004
    lvs:
      class: high-traffic2
      conftool:
        cluster: cloudelastic
        service: cloudelastic-psi-ssl-public
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    port: 8643
    sites:
      - eqiad
    state: production
  cxserver:
    description: Content Translation service, cxserver.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.18
      eqiad:
        default: 10.2.2.18
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/_info
      scheduler: wrr
    monitoring:
      check_command: check_https_lvs_on_port!cxserver.discovery.wmnet!4002!/_info
      critical: true
      sites:
        codfw:
          hostname: cxserver.svc.codfw.wmnet
        eqiad:
          hostname: cxserver.svc.eqiad.wmnet
    port: 4002
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: cxserver
        active_active: true
  docker-registry:
    description: docker registry service
    encryption: true
    ip:
      codfw:
        default: 10.2.1.44
      eqiad:
        default: 10.2.2.44
    lvs:
      class: low-traffic
      conftool:
        cluster: docker-registry
        service: docker-registry
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    monitoring:
      check_command: check_https_url!docker-registry.discovery.wmnet!/v2/
      critical: true
      sites:
        codfw:
          hostname: docker-registry.svc.codfw.wmnet
        eqiad:
          hostname: docker-registry.svc.eqiad.wmnet
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: docker-registry
        active_active: false
  druid-public-broker:
    description: Broker query service for the Druid Public Cluster
    encryption: false
    ip:
      eqiad:
        default: 10.2.2.38
    lvs:
      class: low-traffic
      conftool:
        cluster: druid-public
        service: druid-public-broker
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/status
      scheduler: wrr
    monitoring:
      check_command: check_http_lvs_on_port!druid-public-broker.svc.eqiad.wmnet!8082!/status
      critical: false
      sites:
        eqiad:
          hostname: druid-public-broker.svc.eqiad.wmnet
    port: 8082
    sites:
      - eqiad
    state: production
  echostore:
    description: Echo store, echostore.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.49
      eqiad:
        default: 10.2.2.49
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/healthz
      scheduler: wrr
    monitoring:
      check_command: check_https_port_status!8082!200!/healthz
      critical: false
      sites:
        codfw:
          hostname: echostore.svc.codfw.wmnet
        eqiad:
          hostname: echostore.svc.eqiad.wmnet
    port: 8082
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: echostore
        active_active: true
  eventgate-analytics:
    description: EventGate Analytics endpoint, TLS enabled. https://eventgate-analytics.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.42
      eqiad:
        default: 10.2.2.42
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/_info
      scheduler: wrr
    monitoring:
      check_command: check_https_lvs_on_port!eventgate-analytics.discovery.wmnet!4592!/_info
      critical: true
      sites:
        codfw:
          hostname: eventgate-analytics.svc.codfw.wmnet
        eqiad:
          hostname: eventgate-analytics.svc.eqiad.wmnet
    port: 4592
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: eventgate-analytics
        active_active: true
  eventgate-logging-external:
    description: EventGate logging endpoint, eventgate-logging-external.svc.%{::site}.wmnet and intake-logging.wikimedia.org
    encryption: true
    ip:
      codfw:
        default: 10.2.1.50
      eqiad:
        default: 10.2.2.50
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/_info
      scheduler: wrr
    monitoring:
      check_command: check_https_lvs_on_port!eventgate-logging-external.discovery.wmnet!4392!/_info
      critical: false
      sites:
        codfw:
          hostname: eventgate-logging-external.svc.codfw.wmnet
        eqiad:
          hostname: eventgate-logging-external.svc.eqiad.wmnet
    port: 4392
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: eventgate-logging-external
        active_active: true
  eventgate-analytics-external:
    description: EventGate analytics external endpoint, eventgate-analytics-external.svc.%{::site}.wmnet and intake-analytics.wikimedia.org
    encryption: true
    ip:
      codfw:
        default: 10.2.1.52
      eqiad:
        default: 10.2.2.52
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/_info
      scheduler: wrr
      protocol: tcp
    monitoring:
      check_command: check_https_lvs_on_port!eventgate-analytics-external.discovery.wmnet!4692!/_info
      critical: false
      sites:
        codfw:
          hostname: eventgate-analytics-external.svc.codfw.wmnet
        eqiad:
          hostname: eventgate-analytics-external.svc.eqiad.wmnet
    port: 4692
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: eventgate-analytics-external
        active_active: true
  eventgate-main:
    description: EventGate main endpoint, TLS enabled, https://eventgate-main.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.45
      eqiad:
        default: 10.2.2.45
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/_info
      scheduler: wrr
    monitoring:
      check_command: check_https_lvs_on_port!eventgate-main.discovery.wmnet!4492!/_info
      critical: true
      sites:
        codfw:
          hostname: eventgate-main.svc.codfw.wmnet
        eqiad:
          hostname: eventgate-main.svc.eqiad.wmnet
    port: 4492
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: eventgate-main
        active_active: true
  eventstreams:
    description: Public streams of events via HTTP + SSE, backed by Kafka. eventstreams.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.34
      eqiad:
        default: 10.2.2.34
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/_info
      scheduler: wrr
    monitoring:
      check_command: check_https_lvs_on_port!eventstreams.discovery.wmnet!4892!/_info
      critical: false
      sites:
        codfw:
          hostname: eventstreams.svc.codfw.wmnet
        eqiad:
          hostname: eventstreams.svc.eqiad.wmnet
    port: 4892
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: eventstreams
        active_active: true
  eventstreams-internal:
    description: Internal streams of events via HTTP + SSE, backed by Kafka. eventstreams-internal.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.35
      eqiad:
        default: 10.2.2.35
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/_info
      scheduler: wrr
    monitoring:
      check_command: check_https_lvs_on_port!eventstreams-internal.discovery.wmnet!4992!/_info
      critical: false
      sites:
        codfw:
          hostname: eventstreams-internal.svc.codfw.wmnet
        eqiad:
          hostname: eventstreams-internal.svc.eqiad.wmnet
    port: 4992
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: eventstreams-internal
        active_active: true
  git-ssh:
    description: Git - to Phabricator hosting, git-ssh.wikimedia.org
    encryption: true
    ip:
      codfw:
        git-ssh4: 208.80.153.250
        git-ssh6: 2620:0:860:ed1a::3:fa
      eqiad:
        git-ssh4: 208.80.154.250
        git-ssh6: 2620:0:861:ed1a::3:16
    lvs:
      class: high-traffic2
      conftool:
        cluster: phabricator
        service: git-ssh
      depool_threshold: ".6"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 22
    sites:
      - eqiad
      - codfw
    state: production
  jobrunner:
    description: JobRunner LVS interface (https). jobrunner.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.26
      eqiad:
        default: 10.2.2.26
    lvs:
      class: low-traffic
      conftool:
        cluster: jobrunner
        service: nginx
      depool_threshold: ".2"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/w/health-check.php
      scheduler: wrr
    monitoring:
      check_command: check_https_url!jobrunner.discovery.wmnet!/w/health-check.php
      critical: true
      sites:
        codfw:
          hostname: jobrunner.svc.codfw.wmnet
        eqiad:
          hostname: jobrunner.svc.eqiad.wmnet
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: jobrunner
        active_active: false
  kartotherian:
    description: Kartotherian, kartotherian.svc.%{::site}.wmnet
    encryption: false
    ip:
      codfw:
        default: 10.2.1.13
      eqiad:
        default: 10.2.2.13
    lvs:
      class: low-traffic
      conftool:
        cluster: maps
        service: kartotherian
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    monitoring:
      check_command: check_http_lvs_on_port!kartotherian.discovery.wmnet!6533!/osm-intl/6/23/24.png
      critical: false
      sites:
        codfw:
          hostname: kartotherian.svc.codfw.wmnet
        eqiad:
          hostname: kartotherian.svc.eqiad.wmnet
    port: 6533
    sites:
      - codfw
      - eqiad
    state: production
  kartotherian-ssl:
    description: Kartotherian, kartotherian.svc.%{::site}.wmnet - HTTPS
    encryption: true
    ip:
      codfw:
        default: 10.2.1.13
      eqiad:
        default: 10.2.2.13
    lvs:
      class: low-traffic
      conftool:
        cluster: maps
        service: kartotherian-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    monitoring:
      check_command: check_https_url!kartotherian.discovery.wmnet!/osm-intl/6/23/24.png
      critical: false
      sites:
        codfw:
          hostname: kartotherian.svc.codfw.wmnet
        eqiad:
          hostname: kartotherian.svc.eqiad.wmnet
    port: 443
    sites:
      - codfw
      - eqiad
    state: production
    discovery:
      - dnsdisc: kartotherian
        active_active: true
  kibana:
    description: Kibana
    encryption: false
    ip:
      codfw:
        default: 10.2.1.33
      eqiad:
        default: 10.2.2.33
    lvs:
      class: low-traffic
      conftool:
        cluster: logstash
        service: kibana
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/api/status
      scheduler: sh
    monitoring:
      check_command: check_http_lvs_on_port!kibana.discovery.wmnet!80!/api/status
      critical: true
      sites:
        codfw:
          hostname: kibana.svc.codfw.wmnet
        eqiad:
          hostname: kibana.svc.eqiad.wmnet
    port: 80
    sites:
      - eqiad
      - codfw
    state: production
  kibana-ssl:
    description: Kibana - HTTPS
    encryption: true
    ip:
      codfw:
        default: 10.2.1.33
      eqiad:
        default: 10.2.2.33
    lvs:
      class: low-traffic
      conftool:
        cluster: logstash
        service: kibana-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/api/status
      scheduler: sh
    monitoring:
      check_command: check_https_url!kibana.discovery.wmnet!/api/status
      critical: true
      sites:
        codfw:
          hostname: kibana.svc.codfw.wmnet
        eqiad:
          hostname: kibana.svc.eqiad.wmnet
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: kibana
        active_active: false
  kibana7:
    description: Kibana v7 env - HTTPS
    encryption: true
    ip:
      codfw:
        default: 10.2.1.48
      eqiad:
        default: 10.2.2.48
    lvs:
      class: low-traffic
      conftool:
        cluster: kibana7
        service: kibana7
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/api/status
      scheduler: sh
    monitoring:
      check_command: check_https_url!logstash-next.wikimedia.org!/api/status
      critical: false
      sites:
        codfw:
          hostname: kibana7.svc.codfw.wmnet
        eqiad:
          hostname: kibana7.svc.eqiad.wmnet
    port: 443
    sites:
      - eqiad
      - codfw
    state: lvs_setup
  kubemaster:
    description: Kubernetes master service. kubemaster.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.8
      eqiad:
        default: 10.2.2.8
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubemaster
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 6443
    sites:
      - eqiad
      - codfw
    state: production
  labweb:
    description: "lvs for labweb services: horizon, striker, wikitech"
    encryption: false
    ip:
      eqiad:
        default: 10.2.2.40
    lvs:
      class: low-traffic
      conftool:
        cluster: labweb
        service: labweb
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 30
          timeout-clean-reconnect: 3
        ProxyFetch:
          http_status: 301
          url:
            - http://localhost
      scheduler: wrr
    monitoring:
      check_command: check_http_on_port!80
      critical: false
      sites:
        eqiad:
          hostname: labweb.svc.eqiad.wmnet
    port: 80
    sites:
      - eqiad
    state: production
  labweb-ssl:
    description: "lvs for labweb services: horizon, striker, wikitech - HTTPS"
    encryption: true
    ip:
      eqiad:
        default: 10.2.2.40
    lvs:
      class: low-traffic
      conftool:
        cluster: labweb
        service: labweb-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 30
          timeout-clean-reconnect: 3
        ProxyFetch:
          http_status: 301
          url:
            - https://wikitech.wikimedia.org:7443
      scheduler: wrr
    port: 7443
    sites:
      - eqiad
    state: production
  ldap-ro:
    description: Ldap for cloud and developer accounts
    encryption: false
    ip:
      codfw:
        default: 208.80.153.252
      eqiad:
        default: 208.80.154.252
    lvs:
      class: high-traffic2
      conftool:
        cluster: ldap-ro
        service: ldap-ro
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 30
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 389
    sites:
      - codfw
      - eqiad
    state: production
  ldap-ro-ssl:
    description: Ldap for cloud and developer accounts (ssl access)
    encryption: true
    ip:
      codfw:
        default: 208.80.153.252
      eqiad:
        default: 208.80.154.252
    lvs:
      class: high-traffic2
      conftool:
        cluster: ldap-ro
        service: ldap-ro-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 30
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 636
    sites:
      - codfw
      - eqiad
    state: production
  logstash-gelf:
    description: Logstash ingestion gelf
    encryption: false
    ip:
      eqiad:
        default: 10.2.2.36
    lvs:
      class: low-traffic
      conftool:
        cluster: logstash
        service: logstash-gelf
      depool_threshold: ".5"
      enabled: true
      monitors:
        UDP:
          icmp-timeout: 20
          interval: 10
      protocol: udp
      scheduler: sh
    port: 12201
    sites:
      - eqiad
    state: production
  logstash-json-tcp:
    description: Logstash ingestion json tcp
    encryption: false
    ip:
      eqiad:
        default: 10.2.2.36
    lvs:
      class: low-traffic
      conftool:
        cluster: logstash
        service: logstash-json
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: sh
    monitoring:
      check_command: check_tcp!11514
      critical: true
      sites:
        eqiad:
          hostname: logstash.svc.eqiad.wmnet
    port: 11514
    sites:
      - eqiad
    state: production
  logstash-json-udp:
    description: Logstash ingestion json udp
    encryption: false
    ip:
      eqiad:
        default: 10.2.2.36
    lvs:
      class: low-traffic
      conftool:
        cluster: logstash
        service: logstash-json
      depool_threshold: ".5"
      enabled: true
      monitors:
        UDP:
          icmp-timeout: 20
          interval: 10
      protocol: udp
      scheduler: wrr
    port: 11514
    sites:
      - eqiad
    state: production
  logstash-udp2log:
    description: Logstash ingestion udp2log
    encryption: false
    ip:
      eqiad:
        default: 10.2.2.36
    lvs:
      class: low-traffic
      conftool:
        cluster: logstash
        service: logstash-udp2log
      depool_threshold: ".5"
      enabled: true
      monitors:
        UDP:
          icmp-timeout: 20
          interval: 10
      protocol: udp
      scheduler: wrr
    port: 8324
    sites:
      - eqiad
    state: production
  mathoid:
    description: Mathematical rendering service, mathoid.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.20
      eqiad:
        default: 10.2.2.20
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/_info
      scheduler: wrr
    monitoring:
      check_command: check_https_lvs_on_port!mathoid.discovery.wmnet!4001!/_info
      critical: true
      sites:
        codfw:
          hostname: mathoid.svc.codfw.wmnet
        eqiad:
          hostname: mathoid.svc.eqiad.wmnet
    port: 4001
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: mathoid
        active_active: true
  ml-ctrl:
    description: Kubernetes master service for ML cluster. ml-ctrl.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.39
      eqiad:
        default: 10.2.2.39
    lvs:
      class: low-traffic
      conftool:
        cluster: ml_serve
        service: kubemaster
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 6443
    sites:
      - eqiad
      - codfw
    state: lvs_setup
  mobileapps:
    description:
      A service for use by mobile apps. Provides DOM manipulation, aggregation,
      JSON flattening. mobileapps.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.14
      eqiad:
        default: 10.2.2.14
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    monitoring:
      check_command: check_https_lvs_on_port!mobileapps.discovery.wmnet!4102!/_info
      contact_group: mobileapps
      critical: true
      sites:
        codfw:
          hostname: mobileapps.svc.codfw.wmnet
        eqiad:
          hostname: mobileapps.svc.eqiad.wmnet
    port: 4102
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: mobileapps
        active_active: true
  ncredir:
    description: Non canonical domains redirect service
    encryption: false
    ip: &id005
      codfw:
        ncredirlb: 208.80.153.232
        ncredirlb6: 2620:0:860:ed1a::9
      eqiad:
        ncredirlb: 208.80.154.232
        ncredirlb6: 2620:0:861:ed1a::9
      esams:
        ncredirlb: 91.198.174.194
        ncredirlb6: 2620:0:862:ed1a::3
      ulsfo:
        ncredirlb: 198.35.26.98
        ncredirlb6: 2620:0:863:ed1a::3
      eqsin:
        ncredirlb: 103.102.166.226
        ncredirlb6: 2001:df2:e500:ed1a::3
    lvs:
      class: high-traffic1
      conftool:
        cluster: ncredir
        service: nginx
      depool_threshold: ".5"
      enabled: true
      monitors:
        ProxyFetch:
          url:
            - http://en.wikipedia.com/_status
      scheduler: wrr
    monitoring:
      check_command: check_http_lvs!en.wikipedia.com!/_status
      critical: true
      sites:
        codfw:
          hostname: ncredir-lb.codfw.wikimedia.org
        eqiad:
          hostname: ncredir-lb.eqiad.wikimedia.org
        esams:
          hostname: ncredir-lb.esams.wikimedia.org
        eqsin:
          hostname: ncredir-lb.eqsin.wikimedia.org
        ulsfo:
          hostname: ncredir-lb.ulsfo.wikimedia.org
    port: 80
    sites:
      - eqiad
      - codfw
      - esams
      - ulsfo
      - eqsin
    state: production
  ncredir-https:
    description: Non canonical redirect service
    encryption: true
    ip: *id005
    lvs:
      class: high-traffic1
      conftool:
        cluster: ncredir
        service: nginx
      depool_threshold: ".5"
      enabled: true
      monitors:
        ProxyFetch:
          url:
            - https://en.wikipedia.com/_status
      scheduler: wrr
    monitoring:
      check_command: check_https_url!en.wikipedia.com!/_status
      critical: true
      sites:
        codfw:
          hostname: ncredir-lb.codfw.wikimedia.org
        eqiad:
          hostname: ncredir-lb.eqiad.wikimedia.org
        esams:
          hostname: ncredir-lb.esams.wikimedia.org
        eqsin:
          hostname: ncredir-lb.eqsin.wikimedia.org
        ulsfo:
          hostname: ncredir-lb.ulsfo.wikimedia.org
    port: 443
    sites:
      - eqiad
      - codfw
      - esams
      - ulsfo
      - eqsin
    state: production
  ores:
    description: Objective Revision Evaluation Service. ores.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.10
      eqiad:
        default: 10.2.2.10
    lvs:
      class: low-traffic
      conftool:
        cluster: ores
        service: ores
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/v2/scores/
      scheduler: wrr
    monitoring:
      check_command: check_https_url!ores.discovery.wmnet!/v2/scores/
      critical: true
      sites:
        codfw:
          hostname: ores.svc.codfw.wmnet
        eqiad:
          hostname: ores.svc.eqiad.wmnet
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: ores
        active_active: true
  parsoid-php:
    description: Parsoid/PHP wikitext parser for VisualEditor (%{::site})
    encryption: true
    ip:
      codfw:
        default: 10.2.1.28
      eqiad:
        default: 10.2.2.28
    lvs:
      class: low-traffic
      conftool:
        cluster: parsoid
        service: parsoid-php
      depool_threshold: ".6"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://en.wikipedia.org/wiki/Special:BlankPage
      scheduler: wrr
    monitoring:
      check_command: check_https_url!en.wikipedia.org!/wiki/Special:BlankPage
      critical: true
      sites:
        codfw:
          hostname: parsoid.svc.codfw.wmnet
        eqiad:
          hostname: parsoid.svc.eqiad.wmnet
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: parsoid-php
        active_active: false
  prometheus:
    description: Prometheus monitoring
    encryption: false
    ip:
      codfw:
        default: 10.2.1.25
      eqiad:
        default: 10.2.2.25
    lvs:
      class: low-traffic
      conftool:
        cluster: prometheus
        service: prometheus
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://prometheus/
      scheduler: wrr
    monitoring:
      check_command: check_http_lvs_on_port!prometheus!80!/
      critical: true
      sites:
        codfw:
          hostname: prometheus.svc.codfw.wmnet
        eqiad:
          hostname: prometheus.svc.eqiad.wmnet
    port: 80
    sites:
      - eqiad
      - codfw
    state: production
  proton:
    description: Proton PDF rendering service. proton.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.21
      eqiad:
        default: 10.2.2.21
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/_info
      scheduler: wrr
    monitoring:
      check_command: check_https_lvs_on_port!proton.discovery.wmnet!4030!/_info
      critical: false
      sites:
        codfw:
          hostname: proton.svc.codfw.wmnet
        eqiad:
          hostname: proton.svc.eqiad.wmnet
    port: 4030
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: proton
        active_active: true
  push-notifications:
    description: Push-notifications service push-notifications.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.56
      eqiad:
        default: 10.2.2.56
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/_info
      scheduler: wrr
    monitoring:
      check_command: check_https_lvs_on_port!push-notifications.discovery.wmnet!4104!/_info
      critical: false #change to true when in production
      sites:
        codfw:
          hostname: push-notifications.svc.codfw.wmnet
        eqiad:
          hostname: push-notifications.svc.eqiad.wmnet
    port: 4104
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: push-notifications
        active_active: true
  recommendation-api:
    description: Service for recommendation API. recommendation-api.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.37
      eqiad:
        default: 10.2.2.37
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/robots.txt
      scheduler: wrr
    monitoring:
      check_command: check_https_lvs_on_port!recommendation-api.discovery.wmnet!4632!/robots.txt
      critical: true
      sites:
        codfw:
          hostname: recommendation-api.svc.codfw.wmnet
        eqiad:
          hostname: recommendation-api.svc.eqiad.wmnet
    port: 4632
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: recommendation-api
        active_active: true
  restbase-backend:
    description: RESTBase backend, restbase.svc.%{::site}.wmnet
    encryption: false
    ip:
      codfw:
        default: 10.2.1.17
      eqiad:
        default: 10.2.2.17
    lvs:
      class: low-traffic
      conftool:
        cluster: restbase
        service: restbase-backend
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/
      scheduler: wrr
    port: 7233
    sites:
      - eqiad
      - codfw
    state: production
  restbase-https:
    description: RESTBase, restbase.svc.%{::site}.wmnet - HTTPS
    encryption: true
    ip:
      codfw:
        default: 10.2.1.17
      eqiad:
        default: 10.2.2.17
    lvs:
      class: low-traffic
      conftool:
        cluster: restbase
        service: restbase-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    monitoring:
      check_command: check_https_lvs_on_port!restbase.discovery.wmnet!7443!/
      critical: true
      sites:
        codfw:
          hostname: restbase.svc.codfw.wmnet
        eqiad:
          hostname: restbase.svc.eqiad.wmnet
    port: 7443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: restbase
        active_active: true
      - dnsdisc: restbase-async
        active_active: true
  schema:
    description: Event Schema HTTP service
    encryption: true
    ip:
      codfw:
        default: 10.2.1.43
      eqiad:
        default: 10.2.2.43
    lvs:
      class: low-traffic
      conftool:
        cluster: eventschemas
        service: eventschemas
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/repositories/
      scheduler: wrr
    monitoring:
      check_command: check_https_lvs_on_port!schema.discovery.wmnet!443!/repositories/
      critical: false
      sites:
        codfw:
          hostname: schema.svc.codfw.wmnet
        eqiad:
          hostname: schema.svc.eqiad.wmnet
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: schema
        active_active: true
  search:
    description: Elasticsearch search for MediaWiki
    encryption: false
    ip:
      codfw:
        default: 10.2.1.30
      eqiad:
        default: 10.2.2.30
    lvs:
      class: low-traffic
      conftool:
        cluster: elasticsearch
        service: elasticsearch
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/
      scheduler: wrr
    monitoring:
      check_command: check_http_on_port!9200
      critical: true
      sites:
        codfw:
          hostname: search.svc.codfw.wmnet
        eqiad:
          hostname: search.svc.eqiad.wmnet
    port: 9200
    sites:
      - eqiad
      - codfw
    state: production
  search-https:
    description: Elasticsearch search for MediaWiki - HTTPS
    encryption: true
    ip:
      codfw:
        default: 10.2.1.30
      eqiad:
        default: 10.2.2.30
    lvs:
      class: low-traffic
      conftool:
        cluster: elasticsearch
        service: elasticsearch-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    monitoring:
      check_command: check_https_on_port!9243
      critical: true
      sites:
        codfw:
          hostname: search.svc.codfw.wmnet
        eqiad:
          hostname: search.svc.eqiad.wmnet
    port: 9243
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: search
        active_active: true
  search-omega-https:
    description: Elasticsearch search for MediaWiki (Omega cluster) - HTTPS
    encryption: true
    ip:
      codfw:
        default: 10.2.1.30
      eqiad:
        default: 10.2.2.30
    lvs:
      class: low-traffic
      conftool:
        cluster: elasticsearch
        service: elasticsearch-omega-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    monitoring:
      check_command: check_https_on_port!9443
      critical: true
      sites:
        codfw:
          hostname: search.svc.codfw.wmnet
        eqiad:
          hostname: search.svc.eqiad.wmnet
    port: 9443
    sites:
      - eqiad
      - codfw
    state: production
  search-psi-https:
    description: Elasticsearch search for MediaWiki (Psi cluster) - HTTPS
    encryption: true
    ip:
      codfw:
        default: 10.2.1.30
      eqiad:
        default: 10.2.2.30
    lvs:
      class: low-traffic
      conftool:
        cluster: elasticsearch
        service: elasticsearch-psi-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/
      scheduler: wrr
    monitoring:
      check_command: check_https_on_port!9643
      critical: true
      sites:
        codfw:
          hostname: search.svc.codfw.wmnet
        eqiad:
          hostname: search.svc.eqiad.wmnet
    port: 9643
    sites:
      - eqiad
      - codfw
    state: production
  sessionstore:
    description: Session store, sessionstore.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.29
      eqiad:
        default: 10.2.2.29
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/healthz
      scheduler: wrr
    monitoring:
      check_command: check_https_port_status!8081!200!/healthz
      critical: true
      sites:
        codfw:
          hostname: sessionstore.svc.codfw.wmnet
        eqiad:
          hostname: sessionstore.svc.eqiad.wmnet
    port: 8081
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: sessionstore
        active_active: true
  shellbox:
    description: Shellbox, shellbox.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.51
      eqiad:
        default: 10.2.2.51
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/healthz
      scheduler: wrr
      protocol: tcp
    monitoring:
      check_command: check_https_lvs_on_port!shellbox.discovery.wmnet!4008!/healthz
      critical: false # don't enable paging while testing
      sites:
        codfw:
          hostname: shellbox.svc.codfw.wmnet
        eqiad:
          hostname: shellbox.svc.eqiad.wmnet
    port: 4008
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: shellbox
        active_active: true
  swift:
    description: Swift media storage
    encryption: false
    ip:
      codfw:
        default: 10.2.1.27
      eqiad:
        default: 10.2.2.27
    lvs:
      class: low-traffic
      conftool:
        cluster: swift
        service: swift-fe
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/monitoring/frontend
      scheduler: wrr
    monitoring:
      check_command: check_http_lvs!localhost!/monitoring/frontend
      critical: true
      sites:
        codfw:
          hostname: ms-fe.svc.codfw.wmnet
        eqiad:
          hostname: ms-fe.svc.eqiad.wmnet
    port: 80
    sites:
      - codfw
      - eqiad
    state: production
  swift-https:
    description: Swift media storage
    encryption: true
    ip:
      codfw:
        default: 10.2.1.27
      eqiad:
        default: 10.2.2.27
    lvs:
      class: low-traffic
      conftool:
        cluster: swift
        service: nginx
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/monitoring/frontend
      scheduler: wrr
    monitoring:
      check_command: check_https_url!localhost!/monitoring/frontend
      critical: true
      sites:
        codfw:
          hostname: ms-fe.svc.codfw.wmnet
        eqiad:
          hostname: ms-fe.svc.eqiad.wmnet
    port: 443
    sites:
      - codfw
      - eqiad
    state: production
    discovery:
      - dnsdisc: swift
        active_active: true
      - dnsdisc: swift-rw # TODO: remove this from DNS!
        active_active: false
      - dnsdisc: swift-ro # TODO: remove this from DNS!
        active_active: true
  thanos-query:
    description: Prometheus long-term storage, query service
    encryption: true
    ip:
      codfw:
        default: 10.2.1.53
      eqiad:
        default: 10.2.2.53
    lvs:
      class: low-traffic
      conftool:
        cluster: thanos
        service: thanos-query
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://thanos-query.discovery.wmnet/-/ready
      scheduler: wrr
    monitoring:
      check_command: check_https_url!thanos-query.discovery.wmnet!/-/ready
      critical: true
      sites:
        codfw:
          hostname: thanos-query.svc.codfw.wmnet
        eqiad:
          hostname: thanos-query.svc.eqiad.wmnet
    port: 443
    sites:
      - codfw
      - eqiad
    state: production
    discovery:
      - dnsdisc: thanos-query
        active_active: true
  thanos-swift:
    description: Prometheus long-term storage, object storage (swift) access
    encryption: true
    ip:
      codfw:
        default: 10.2.1.54
      eqiad:
        default: 10.2.2.54
    lvs:
      class: low-traffic
      conftool:
        cluster: thanos
        service: thanos-swift
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://thanos-swift.discovery.wmnet/healthcheck
      scheduler: wrr
    monitoring:
      check_command: check_https_url!thanos-swift.discovery.wmnet!/healthcheck
      critical: true
      sites:
        codfw:
          hostname: thanos-swift.svc.codfw.wmnet
        eqiad:
          hostname: thanos-swift.svc.eqiad.wmnet
    port: 443
    sites:
      - codfw
      - eqiad
    state: production
    discovery:
      - dnsdisc: thanos-swift
        active_active: true
  termbox:
    description: Wikidata Termbox SSR termbox.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.46
      eqiad:
        default: 10.2.2.46
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/_info
      scheduler: wrr
    monitoring:
      check_command: check_https_lvs_on_port!termbox.discovery.wmnet!4004!/_info
      critical: true
      sites:
        codfw:
          hostname: termbox.svc.codfw.wmnet
        eqiad:
          hostname: termbox.svc.eqiad.wmnet
    port: 4004
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: termbox
        active_active: true
  text:
    description: Main wiki platform LVS service, text.%{::site}.wikimedia.org (Varnish)
    encryption: false
    ip:
      codfw: &id006
        testlb: 208.80.153.225
        testlb6: 2620:0:860:ed1a::2
        textlb: 208.80.153.224
        textlb6: 2620:0:860:ed1a::1
      eqiad: &id007
        testlb: 208.80.154.225
        testlb6: 2620:0:861:ed1a::2
        textlb: 208.80.154.224
        textlb6: 2620:0:861:ed1a::1
      eqsin: &id008
        testlb: 103.102.166.225
        testlb6: 2001:df2:e500:ed1a::2
        textlb: 103.102.166.224
        textlb6: 2001:df2:e500:ed1a::1
      esams: &id009
        testlb: 91.198.174.193
        testlb6: 2620:0:862:ed1a::2
        textlb: 91.198.174.192
        textlb6: 2620:0:862:ed1a::1
      ulsfo: &id010
        testlb: 198.35.26.97
        testlb6: 2620:0:863:ed1a::2
        textlb: 198.35.26.96
        textlb6: 2620:0:863:ed1a::1
    lvs:
      class: high-traffic1
      conftool:
        cluster: cache_text
        service: varnish-fe
      depool_threshold: ".8"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: sh
    monitoring:
      check_command: check_http_lvs!en.wikipedia.org!/wiki/Special:BlankPage
      critical: true
      sites:
        codfw:
          hostname: text-lb.codfw.wikimedia.org
        eqiad:
          hostname: text-lb.eqiad.wikimedia.org
        eqsin:
          hostname: text-lb.eqsin.wikimedia.org
        esams:
          hostname: text-lb.esams.wikimedia.org
        ulsfo:
          hostname: text-lb.ulsfo.wikimedia.org
    port: 80
    sites:
      - codfw
      - eqiad
      - esams
      - ulsfo
      - eqsin
    state: production
  text-https:
    description: Main wiki platform LVS service, text.%{::site}.wikimedia.org (nginx)
    encryption: true
    ip:
      codfw: *id006
      eqiad: *id007
      eqsin: *id008
      esams: *id009
      ulsfo: *id010
    lvs:
      class: high-traffic1
      conftool:
        cluster: cache_text
        service: ats-tls
      depool_threshold: ".8"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://healthcheck.wikimedia.org/varnish-fe
      scheduler: sh
    monitoring:
      check_command: check_https_url!en.wikipedia.org!/wiki/Special:BlankPage
      critical: true
      sites:
        codfw:
          hostname: text-lb.codfw.wikimedia.org
        eqiad:
          hostname: text-lb.eqiad.wikimedia.org
        eqsin:
          hostname: text-lb.eqsin.wikimedia.org
        esams:
          hostname: text-lb.esams.wikimedia.org
        ulsfo:
          hostname: text-lb.ulsfo.wikimedia.org
    port: 443
    sites:
      - codfw
      - eqiad
      - esams
      - ulsfo
      - eqsin
    state: production
  thumbor:
    description: Thumbor image scaling
    encryption: false
    ip:
      codfw:
        default: 10.2.1.24
      eqiad:
        default: 10.2.2.24
    lvs:
      class: low-traffic
      conftool:
        cluster: thumbor
        service: thumbor
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          timeout: 10
          url:
            - http://localhost/healthcheck
      scheduler: wrr
    monitoring:
      check_command: check_http_lvs_on_port_timeout!thumbor.discovery.wmnet!8800!/healthcheck!20
      critical: true
      sites:
        codfw:
          hostname: thumbor.svc.codfw.wmnet
        eqiad:
          hostname: thumbor.svc.eqiad.wmnet
    port: 8800
    sites:
      - eqiad
      - codfw
    state: production
  upload:
    description: Images and other media, upload.%{::site}.wikimedia.org
    encryption: false
    ip:
      codfw: &id011
        uploadlb: 208.80.153.240
        uploadlb6: 2620:0:860:ed1a::2:b
      eqiad: &id012
        uploadlb: 208.80.154.240
        uploadlb6: 2620:0:861:ed1a::2:b
      eqsin: &id013
        uploadlb: 103.102.166.240
        uploadlb6: 2001:df2:e500:ed1a::2:b
      esams: &id014
        uploadlb: 91.198.174.208
        uploadlb6: 2620:0:862:ed1a::2:b
      ulsfo: &id015
        uploadlb: 198.35.26.112
        uploadlb6: 2620:0:863:ed1a::2:b
    lvs:
      class: high-traffic2
      conftool:
        cluster: cache_upload
        service: varnish-fe
      depool_threshold: ".8"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: sh
    monitoring:
      check_command: check_http_lvs!upload.wikimedia.org!/monitoring/backend
      critical: true
      sites:
        codfw:
          hostname: upload-lb.codfw.wikimedia.org
        eqiad:
          hostname: upload-lb.eqiad.wikimedia.org
        eqsin:
          hostname: upload-lb.eqsin.wikimedia.org
        esams:
          hostname: upload-lb.esams.wikimedia.org
        ulsfo:
          hostname: upload-lb.ulsfo.wikimedia.org
    port: 80
    sites:
      - codfw
      - eqiad
      - esams
      - ulsfo
      - eqsin
    state: production
  upload-https:
    description: Images and other media, upload.%{::site}.wikimedia.org
    encryption: true
    ip:
      codfw: *id011
      eqiad: *id012
      eqsin: *id013
      esams: *id014
      ulsfo: *id015
    lvs:
      class: high-traffic2
      conftool:
        cluster: cache_upload
        service: ats-tls
      depool_threshold: ".8"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://healthcheck.wikimedia.org/varnish-fe
      scheduler: sh
    monitoring:
      check_command: check_https_url!upload.wikimedia.org!/monitoring/backend
      critical: true
      sites:
        codfw:
          hostname: upload-lb.codfw.wikimedia.org
        eqiad:
          hostname: upload-lb.eqiad.wikimedia.org
        eqsin:
          hostname: upload-lb.eqsin.wikimedia.org
        esams:
          hostname: upload-lb.esams.wikimedia.org
        ulsfo:
          hostname: upload-lb.ulsfo.wikimedia.org
    port: 443
    sites:
      - codfw
      - eqiad
      - esams
      - ulsfo
      - eqsin
    state: production
  videoscaler:
    description: Videoscaler LVS interface (https). videoscaler.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.5
      eqiad:
        default: 10.2.2.5
    lvs:
      class: low-traffic
      conftool:
        cluster: videoscaler
        service: nginx
      depool_threshold: ".2"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/w/health-check.php
      scheduler: wrr
    monitoring:
      check_command: check_https_url!videoscaler.discovery.wmnet!/w/health-check.php
      critical: true
      sites:
        codfw:
          hostname: videoscaler.svc.codfw.wmnet
        eqiad:
          hostname: videoscaler.svc.eqiad.wmnet
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: videoscaler
        active_active: false
  wdqs:
    description: Wikidata Query Service
    encryption: false
    ip:
      codfw:
        default: 10.2.1.32
      eqiad:
        default: 10.2.2.32
    lvs:
      class: low-traffic
      conftool:
        cluster: wdqs
        service: wdqs
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/readiness-probe
      scheduler: wrr
    monitoring:
      check_command: check_http_lvs_on_port!wdqs.discovery.wmnet!80!/readiness-probe
      critical: true
      sites:
        codfw:
          hostname: wdqs.svc.codfw.wmnet
        eqiad:
          hostname: wdqs.svc.eqiad.wmnet
    port: 80
    sites:
      - eqiad
      - codfw
    state: production
  wdqs-heavy-queries:
    description: Wikidata Query Service for heavy queries
    encryption: false
    ip:
      codfw:
        default: 10.2.1.32
      eqiad:
        default: 10.2.2.32
    lvs:
      class: low-traffic
      conftool:
        cluster: wdqs
        service: wdqs-heavy-queries
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/readiness-probe
      scheduler: wrr
    port: 8888
    sites:
      - eqiad
      - codfw
    state: production
  wdqs-internal:
    description: Wikidata Query Service - internal
    encryption: false
    ip:
      codfw:
        default: 10.2.1.41
      eqiad:
        default: 10.2.2.41
    lvs:
      class: low-traffic
      conftool:
        cluster: wdqs-internal
        service: wdqs
      depool_threshold: ".3"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - http://localhost/readiness-probe
      scheduler: wrr
    monitoring:
      check_command: check_http_lvs_on_port!wdqs-internal.discovery.wmnet!80!/readiness-probe
      critical: true
      sites:
        codfw:
          hostname: wdqs-internal.svc.codfw.wmnet
        eqiad:
          hostname: wdqs-internal.svc.eqiad.wmnet
    port: 80
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: wdqs-internal
        active_active: true
  wdqs-ssl:
    description: Wikidata Query Service - HTTPS
    encryption: true
    ip:
      codfw:
        default: 10.2.1.32
      eqiad:
        default: 10.2.2.32
    lvs:
      class: low-traffic
      conftool:
        cluster: wdqs
        service: wdqs-ssl
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/readiness-probe
      scheduler: wrr
    monitoring:
      check_command: check_https_url!wdqs.discovery.wmnet!/readiness-probe
      critical: true
      sites:
        codfw:
          hostname: wdqs.svc.codfw.wmnet
        eqiad:
          hostname: wdqs.svc.eqiad.wmnet
    port: 443
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: wdqs
        active_active: true
  wikifeeds:
    description: A node webservice supporting featured wiki content feeds. wikifeeds.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.47
      eqiad:
        default: 10.2.2.47
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
        ProxyFetch:
          url:
            - https://localhost/_info
      scheduler: wrr
    monitoring:
      check_command: check_https_lvs_on_port!wikifeeds.discovery.wmnet!4101!/_info
      critical: true
      sites:
        codfw:
          hostname: wikifeeds.svc.codfw.wmnet
        eqiad:
          hostname: wikifeeds.svc.eqiad.wmnet
    port: 4101
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: wikifeeds
        active_active: true
  zotero:
    description: Zotero, zotero.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.16
      eqiad:
        default: 10.2.2.16
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    monitoring:
      check_command: check_https_zotero_lvs_on_port!zotero.discovery.wmnet!4969!/export?format=wikipedia
      critical: true
      sites:
        codfw:
          hostname: zotero.svc.codfw.wmnet
        eqiad:
          hostname: zotero.svc.eqiad.wmnet
    port: 4969
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: zotero
        active_active: true
  # Chartmuseum is not an LVS service. However it does warrant using discovery DC records for it.
  # Note the lack of an 'lvs' stanza in the configuration below. The IPs are the ones of the VMs per DC
  helm-charts:
    description: helm-charts
    encryption: true
    ip:
      codfw:
        default: 10.192.48.159
      eqiad:
        default: 10.64.48.26
    monitoring:
      check_command: check_https_url_for_string!helm-charts.discovery.wmnet!/health!true
      notes_url: "https://wikitech.wikimedia.org/wiki/ChartMuseum"
      critical: false
      sites:
        codfw:
          hostname: chartmuseum2001
        eqiad:
          hostname: chartmuseum1001
    sites:
      - eqiad
      - codfw
    port: 443
    state: lvs_setup
    discovery:
      - dnsdisc: helm-charts
        active_active: true
  # Releases is not an LVS service. However it does warrant using discovery DC records for it.
  # Note the lack of an 'lvs' stanza in the configuration below. The IPs are the ones of the VMs per DC
  releases:
    description: MediaWiki, Parsoid, MobileApps and other Wikimedia realease files (https://releases.wikimedia.org)
    encryption: true
    ip:
      codfw:
        default: 10.192.16.180
      eqiad:
        default: 10.64.48.17
    monitoring:
      check_command: check_https_url_for_string!releases.wikimedia.org!/mediawiki/!MediaWiki
      notes_url: "https://wikitech.wikimedia.org/wiki/Releases.wikimedia.org"
      critical: false
      sites:
        codfw:
          hostname: releases2002
        eqiad:
          hostname: releases1002
    sites:
      - eqiad
      - codfw
    port: 443
    state: lvs_setup
    discovery:
      - dnsdisc: releases
        active_active: true
  api-gateway:
    description: API gateway, api-gateway.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.55
      eqiad:
        default: 10.2.2.55
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    monitoring:
      check_command: check_https_lvs_on_port!api-gateway.discovery.wmnet!8087!/healthz
      critical: false # don't enable paging while testing
      sites:
        codfw:
          hostname: api-gateway.svc.codfw.wmnet
        eqiad:
          hostname: api-gateway.svc.eqiad.wmnet
    port: 8087
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: api-gateway
        active_active: true
  similar-users:
    description: Similar-users/sockpuppet, similar-users.svc.%{::site}.wmnet
    encryption: true
    ip:
      codfw:
        default: 10.2.1.57
      eqiad:
        default: 10.2.2.57
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    monitoring:
      check_command: check_https_lvs_on_port!similar-users.discovery.wmnet!4110!/healthz
      critical: false # don't enable paging while testing
      sites:
        codfw:
          hostname: similar-users.svc.codfw.wmnet
        eqiad:
          hostname: similar-users.svc.eqiad.wmnet
    port: 4110
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: similar-users
        active_active: true
  linkrecommendation:
    description: Link Recommendation, linkrecommendation.svc.%{::site}.wmnet
    encryption: true
    ip: &linkrecommendation_ips
      codfw:
        default: 10.2.1.23
      eqiad:
        default: 10.2.2.23
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    monitoring:
      check_command: check_https_lvs_on_port!linkrecommendation.discovery.wmnet!4005!/healthz
      critical: false # don't enable paging while setting up
      sites:
        codfw:
          hostname: linkrecommendation.svc.codfw.wmnet
        eqiad:
          hostname: linkrecommendation.svc.eqiad.wmnet
    port: 4005
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: linkrecommendation
        active_active: true
  linkrecommendation-external:
    description: Link Recommendation, public release, linkrecommendation.svc.%{::site}.wmnet
    encryption: true
    ip: *linkrecommendation_ips
    lvs:
      class: low-traffic
      conftool:
        cluster: kubernetes
        service: kubesvc
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
      protocol: tcp
    monitoring:
      check_command: check_https_lvs_on_port!linkrecommendation.discovery.wmnet!4006!/healthz
      critical: false # don't enable paging while setting up
      sites:
        codfw:
          hostname: linkrecommendation.svc.codfw.wmnet
        eqiad:
          hostname: linkrecommendation.svc.eqiad.wmnet
    port: 4006
    sites:
      - eqiad
      - codfw
    state: production
    discovery:
      - dnsdisc: linkrecommendation
        active_active: true
  wikireplicas-a-s1:
    description: "lvs for a-side wikireplicas section s1"
    encryption: false
    ip: &wikireplicas_a_ips
      eqiad:
        default: 208.80.154.242
    lvs:
      class: high-traffic2
      conftool:
        cluster: wikireplicas-a
        service: wikireplicas-a
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 3311
    sites:
      - eqiad
    state: production
  wikireplicas-a-s2:
    description: "lvs for a-side wikireplicas section s2"
    encryption: false
    ip: *wikireplicas_a_ips
    lvs:
      class: high-traffic2
      conftool:
        cluster: wikireplicas-a
        service: wikireplicas-a
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 3312
    sites:
      - eqiad
    state: production
  wikireplicas-a-s3:
    description: "lvs for a-side wikireplicas section s3"
    encryption: false
    ip: *wikireplicas_a_ips
    lvs:
      class: high-traffic2
      conftool:
        cluster: wikireplicas-a
        service: wikireplicas-a
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 3313
    sites:
      - eqiad
    state: production
  wikireplicas-a-s4:
    description: "lvs for a-side wikireplicas section s4"
    encryption: false
    ip: *wikireplicas_a_ips
    lvs:
      class: high-traffic2
      conftool:
        cluster: wikireplicas-a
        service: wikireplicas-a
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 3314
    sites:
      - eqiad
    state: production
  wikireplicas-a-s5:
    description: "lvs for a-side wikireplicas section s5"
    encryption: false
    ip: *wikireplicas_a_ips
    lvs:
      class: high-traffic2
      conftool:
        cluster: wikireplicas-a
        service: wikireplicas-a
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 3315
    sites:
      - eqiad
    state: production
  wikireplicas-a-s6:
    description: "lvs for a-side wikireplicas section s6"
    encryption: false
    ip: *wikireplicas_a_ips
    lvs:
      class: high-traffic2
      conftool:
        cluster: wikireplicas-a
        service: wikireplicas-a
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 3316
    sites:
      - eqiad
    state: production
  wikireplicas-a-s7:
    description: "lvs for a-side wikireplicas section s7"
    encryption: false
    ip: *wikireplicas_a_ips
    lvs:
      class: high-traffic2
      conftool:
        cluster: wikireplicas-a
        service: wikireplicas-a
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 3317
    sites:
      - eqiad
    state: production
  wikireplicas-a-s8:
    description: "lvs for a-side wikireplicas section s8"
    encryption: false
    ip: *wikireplicas_a_ips
    lvs:
      class: high-traffic2
      conftool:
        cluster: wikireplicas-a
        service: wikireplicas-a
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 3318
    sites:
      - eqiad
    state: production
  wikireplicas-b-s1:
    description: "lvs for b-side wikireplicas section s1"
    encryption: false
    ip: &wikireplicas_b_ips
      eqiad:
        default: 208.80.154.243
    lvs:
      class: high-traffic2
      conftool:
        cluster: wikireplicas-b
        service: wikireplicas-b
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 3311
    sites:
      - eqiad
    state: production
  wikireplicas-b-s2:
    description: "lvs for b-side wikireplicas section s2"
    encryption: false
    ip: *wikireplicas_b_ips
    lvs:
      class: high-traffic2
      conftool:
        cluster: wikireplicas-b
        service: wikireplicas-b
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 3312
    sites:
      - eqiad
    state: production
  wikireplicas-b-s3:
    description: "lvs for b-side wikireplicas section s3"
    encryption: false
    ip: *wikireplicas_b_ips
    lvs:
      class: high-traffic2
      conftool:
        cluster: wikireplicas-b
        service: wikireplicas-b
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 3313
    sites:
      - eqiad
    state: production
  wikireplicas-b-s4:
    description: "lvs for b-side wikireplicas section s4"
    encryption: false
    ip: *wikireplicas_b_ips
    lvs:
      class: high-traffic2
      conftool:
        cluster: wikireplicas-b
        service: wikireplicas-b
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 3314
    sites:
      - eqiad
    state: production
  wikireplicas-b-s5:
    description: "lvs for b-side wikireplicas section s5"
    encryption: false
    ip: *wikireplicas_b_ips
    lvs:
      class: high-traffic2
      conftool:
        cluster: wikireplicas-b
        service: wikireplicas-b
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 3315
    sites:
      - eqiad
    state: production
  wikireplicas-b-s6:
    description: "lvs for b-side wikireplicas section s6"
    encryption: false
    ip: *wikireplicas_b_ips
    lvs:
      class: high-traffic2
      conftool:
        cluster: wikireplicas-b
        service: wikireplicas-b
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 3316
    sites:
      - eqiad
    state: production
  wikireplicas-b-s7:
    description: "lvs for b-side wikireplicas section s7"
    encryption: false
    ip: *wikireplicas_b_ips
    lvs:
      class: high-traffic2
      conftool:
        cluster: wikireplicas-b
        service: wikireplicas-b
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 3317
    sites:
      - eqiad
    state: production
  wikireplicas-b-s8:
    description: "lvs for b-side wikireplicas section s8"
    encryption: false
    ip: *wikireplicas_b_ips
    lvs:
      class: high-traffic2
      conftool:
        cluster: wikireplicas-b
        service: wikireplicas-b
      depool_threshold: ".5"
      enabled: true
      monitors:
        IdleConnection:
          max-delay: 300
          timeout-clean-reconnect: 3
      scheduler: wrr
    port: 3318
    sites:
      - eqiad
    state: production
  # puppetdb-api is not an LVS service. However it does warrant using discovery DC records for it.
  # Note the lack of an 'lvs' stanza in the configuration below.
  puppetdb-api:
    description: Puppetdb api microservice
    encryption: true
    ip:
      codfw:
        default: 10.192.0.147
      eqiad:
        default: 10.64.32.80
    monitoring:
      check_command: "check_https_on_port!8090"
      notes_url: "https://wikitech.wikimedia.org/wiki/Puppet#Micro_Service"
      critical: false
      sites:
        codfw:
          hostname: puppetdb1002
        eqiad:
          hostname: puppetdb2002
    sites:
      - eqiad
      - codfw
    port: 8090
    state: production
    discovery:
      - dnsdisc: puppetdb-api
        active_active: true
